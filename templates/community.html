{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-users me-2"></i>Community Forum</h1>
                {% if session.user_id %}
                <a href="{{ url_for('create_post') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create Post
                </a>
                {% endif %}
            </div>

            <!-- Categories Navigation -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Discussion Categories</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('community') }}" class="btn btn-outline-primary btn-sm">All Topics</a>
                        <a href="{{ url_for('community') }}?category=general" class="btn btn-outline-secondary btn-sm">General</a>
                        <a href="{{ url_for('community') }}?category=events" class="btn btn-outline-success btn-sm">Events</a>
                        <a href="{{ url_for('community') }}?category=help" class="btn btn-outline-warning btn-sm">Help</a>
                        <a href="{{ url_for('community') }}?category=ideas" class="btn btn-outline-info btn-sm">Ideas</a>
                        <a href="{{ url_for('community') }}?category=announcements" class="btn btn-outline-danger btn-sm">Announcements</a>
                    </div>
                </div>
            </div>

            {% if posts %}
                {% for post in posts %}
                <div class="card mb-4 {% if post.is_pinned %}border-warning{% endif %}">
                    <div class="card-body">
                        {% if post.is_pinned %}
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-thumbtack text-warning me-2"></i>
                            <small class="text-warning fw-bold">PINNED POST</small>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-start">
                            <h4 class="card-title">
                                {{ post.title }}
                                <span class="badge bg-secondary ms-2">{{ post.category }}</span>
                            </h4>
                            <small class="text-muted">
                                {{ post.created_at.strftime('%b %d, %Y') }}
                            </small>
                        </div>
                        
                        <p class="card-text">{{ post.content }}</p>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Posted by: <strong>{{ post.author }}</strong>
                            </small>
                            <span class="badge bg-primary">
                                {{ post.comments|length }} comments
                            </span>
                        </div>

                        <!-- Comments Section -->
                        {% if post.comments %}
                        <div class="comments-section mt-4">
                            <h6>Comments:</h6>
                            {% for comment in post.comments %}
                            <div class="card bg-light mb-2">
                                <div class="card-body py-3">
                                    <p class="mb-1">{{ comment.content }}</p>
                                    <small class="text-muted">
                                        By: <strong>{{ comment.author }}</strong> 
                                        on {{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Comment Form -->
                        {% if session.user_id %}
                        <form method="POST" action="{{ url_for('comment_post', post_id=post.id) }}" class="mt-3">
                            <div class="mb-3">
                                <textarea name="content" class="form-control" placeholder="Write your comment..." rows="2" required></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="fas fa-reply me-1"></i>Post Comment
                                </button>
                                {% if post.author == session.username or session.role == 'admin' %}
                                <a href="{{ url_for('delete_post', post_id=post.id) }}" 
                                   class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('Are you sure you want to delete this post?')">
                                    <i class="fas fa-trash me-1"></i>Delete Post
                                </a>
                                {% endif %}
                            </div>
                        </form>
                        {% else %}
                        <div class="alert alert-info mt-3">
                            <a href="{{ url_for('login') }}">Login</a> to comment on this post.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No community posts yet</h4>
                <p class="text-muted">Start the conversation by creating the first post!</p>
                {% if session.user_id %}
                <a href="{{ url_for('create_post') }}" class="btn btn-primary">
                    Create First Post
                </a>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-primary">
                    Login to Participate
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}